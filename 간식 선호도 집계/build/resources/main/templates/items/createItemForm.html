<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<script src="https://code.jquery.com/jquery-3.4.1.js"
        integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
        crossorigin="anonymous">
</script>
<head th:replace="fragments/header :: header" />
<body>
<div class="container">
    <div th:replace="fragments/bodyHeader :: bodyHeader"/>
    <h3>간식 등록</h3>
    <form id="form" th:action="@{/items/new}" th:object="${form}" method="post" onsubmit="return false">
        <div class="form-group">
            <label th:for="name"><strong>간식명</strong></label>
            <input type="text" th:field="*{name}" class="form-control"
                   placeholder="간식명을 입력하세요">
        </div>
        <div class="form-group">
            <label for="inputFile"><strong>간식 사진 파일</strong><span style="color: red;">(첨부 안하셔도 됩니다.)</span></label>
            <div>
                <div class="custom-file" id="inputFile">
                    <input name="file" type="file" class="custom-file-input" id="customFile">
                    <label class="custom-file-label" for="customFile">jpg,png 파일을 선택해 주세요. (파일명 한글x)</label>
                </div>
            </div>
        </div>
        <input id="submit" type="button" class="btn btn-primary" value="전송">
    </form>
    <br/>
    <div th:replace="fragments/footer :: footer" />
</div> <!-- /container -->
</body>
<script>
    var check = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/;
    $(".custom-file-input").on("change", function() {
      var fileName = $(this).val().split("\\").pop();
      let fileLength = fileName.length;
      let fileDot = fileName.lastIndexOf(".");
      let fileType = fileName.substring(fileDot+1, fileLength).toLowerCase();
      if(check.test(fileName)) {
        alert("한글 파일명은 첨부할 수 없습니다.");
        $('#customFile').val('');
        return false;
      }
      if(fileType === "jpg" || fileType === "png" ) {
        $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
      } else {
        alert("jpg파일 및 png파일만 첨부 가능합니다.");
        $('#customFile').val('');
      }
    });

    $("#submit").click(function() {
        let name = $("#name").val();
        let file = $("#customFile").val();
        if(name == "") {
            alert("간식명을 입력해주세요.");
        } else {
            $.ajax({
            type: "POST",
            url: "/items/new",
            processData: false,
            contentType: false,
            enctype: 'multipart/form-data',
            data : new FormData($("#form")[0]),
            success : function(result){
                console.log(result);
                let request = result.status;
                if(request === "OK") {
                    alert("간식 등록이 정상적으로 되었습니다");
                    $("#name").val('');
                    $("#customFile").val('');
                    $(".custom-file-label").html('jpg,png 파일을 선택해 주세요.');
                } else {
                    alert("error");
                }
            },
            error : function(a, b, c) {
                alert("error");
            }
            })
        }
    })
</script>
</html>